<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SRS-2 — Idade Escolar Professores</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .wrap{
    max-width:980px;
    margin:20px auto;
    padding:0 16px
  }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px
  }

  h1{
    margin:0 0 6px;
    font-size:1.45rem
  }
  .muted{color:var(--muted)}

  .grid-info{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin:12px 0 6px
  }
  @media (max-width:720px){
    .grid-info{grid-template-columns:1fr}
  }
  .info{
    background:rgba(0,0,0,.18);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px
  }
  .info b{
    display:block;
    margin-bottom:4px;
    color:#e2e8f0
  }

  .q{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:rgba(0,0,0,.18);
    margin-bottom:12px
  }
  .q h3{
    margin:0 0 10px;
    font-size:1.02rem
  }

  .opts{
    display:flex;
    flex-wrap:wrap;
    gap:10px
  }
  .opt{
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px 14px;
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--chip);
    cursor:pointer;
    min-width:220px;
    transition:transform .05s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
  }
  .opt:hover{
    border-color:#4466aa;
    transform:translateY(-1px)
  }
  .opt input[type="radio"]{
    transform:scale(1.15)
  }
  .opt:has(input[type="radio"]:checked){
    background:var(--pri);
    border-color:var(--pri);
    box-shadow:0 0 0 1px var(--pri) inset;
    color:#fff;
  }
  .opt:has(input[type="radio"]:checked) span{
    color:#fff;
    font-weight:600;
  }
  .opt:has(input[type="radio"]:focus-visible){
    box-shadow:0 0 0 3px rgba(109,40,217,.4);
    border-color:var(--pri);
  }
  @media (max-width:520px){
    .opt{
      min-width:unset;
      flex:1 1 100%
    }
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:12px 16px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600
  }
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .msg{
    margin:12px 0;
    padding:12px;
    border-radius:10px
  }
  .okbox{
    background:#06351f;
    border:1px solid #0e6c45;
    color:#c8ffe3
  }
  .errbox{
    background:#3b0d0d;
    border:1px solid #7f1d1d;
    color:#ffd5d5
  }
  .warnbox{
    background:#3a2903;
    border:1px solid #885e09;
    color:#ffe6b0
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>SRS-2 — Idade Escolar Professores</h1>
    <p class="muted">
      <em>As respostas serão enviadas diretamente para a profissional responsável.</em>
    </p>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <div id="progress" class="muted" style="min-width:160px"></div>
      </div>

      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ========== CONFIG GERAL ========== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = {
  PATIENTS:"Patients",
  TOKENS:"LinkTokens",
  SCORES:"Scores_SRS2_PRE_ESCOLAR_PROF"
};
const CODE = "SRS2_PRE_ESCOLAR_PROF";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["SRS2_PRE_ESCOLAR_PROF"]; // colunas em Patients que liberam o formulário

/* ========== HELPERS BÁSICOS ========== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const TOKEN = qs("token");
const AUTOSAVE_KEY = `${CODE}_${TOKEN||"no_token"}`;

function setBox(id, text, kind="ok"){
  const el = $(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id);
  if(el){
    el.style.display="none";
    el.textContent="";
  }
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = String(iso).split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}

/* chamadas HTTP para SheetDB */
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, {
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if(TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ========== ITENS / OPÇÕES (1..65) ========== */
const ITEMS = [
  "Parece muito mais inquieta em situações sociais do que quando está sozinha.",
  "As expressões em seu rosto não combinam com o que está dizendo.",
  "Parece confiante (ou segura) quando está interagindo com outras pessoas.",
  "Quando há sobrecarga de estímulos, apresenta padrões rígidos ou inflexíveis de comportamento que parecem estranhos.",
  "Não percebe quando os outros estão tentando tirar vantagem dela.",
  "Prefere estar sozinha do que com os outros.",
  "Demonstra perceber o que os outros estão pensando ou sentindo.",
  "Se comporta de maneira estranha ou bizarra.",
  "Fica próxima a adultos, parece ser muito dependente deles.",
  "Leva as coisas muito \"ao pé da letra\" e não compreende o real significado de uma conversa.",
  "É autoconfiante.",
  "É capaz de comunicar seus sentimentos para as outras pessoas.",
  "É estranha na \"tomada de vez\" das interações com seus colegas (por exemplo, não parece entender a reciprocidade de uma conversa).",
  "Não tem boa coordenação.",
  "É capaz de entender o tom de voz e as expressões faciais das outras pessoas.",
  "Evita o contato visual ou tem contato visual diferente.",
  "Reconhece quando algo é injusto.",
  "Tem dificuldade em fazer amigos, mesmo tentando dar o melhor de si.",
  "Fica frustrada quando não consegue expressar suas ideias em uma conversa.",
  "Mostra interesses sensoriais incomuns (por exemplo, coloca na boca ou gira objetos) ou formas estranhas de brincar com brinquedos.",
  "É capaz de imitar as ações de outras pessoas.",
  "Brinca adequadamente com crianças da sua idade.",
  "Não participa de atividades em grupo a menos que seja convidada a fazê-lo.",
  "Tem mais dificuldade do que outras crianças com mudanças na sua rotina.",
  "Não parece se importar em estar fora de sintonia ou em um \"mundo\" diferente dos outros.",
  "Oferece conforto para os outros quando estão tristes.",
  "Evita iniciar interações sociais com seus colegas ou adultos.",
  "Pensa ou fala sobre a mesma coisa repetidamente.",
  "É considerada como estranha ou esquisita por outras crianças.",
  "Fica perturbada em uma situação com muitas coisas acontecendo.",
  "Não consegue tirar algo da sua mente uma vez que começa a pensar sobre isso.",
  "Tem boa higiene pessoal.",
  "É socialmente desajeitada, mesmo quando tenta ser educada.",
  "Evita pessoas que querem se aproximar dela por meio de contato afetivo.",
  "Tem dificuldade em acompanhar o fluxo de uma conversa normal.",
  "Tem dificuldade em se relacionar com adultos.",
  "Tem dificuldade em se relacionar com seus colegas.",
  "Responde adequadamente às mudanças de humor dos outros (por exemplo, quando o humor de um amigo ou companheiro muda de feliz para triste).",
  "Tem uma variedade de interesses extraordinariamente incomuns.",
  "É imaginativa, hábil em fantasiar (contudo sem perder contato com a realidade).",
  "Muda de uma atividade para outra sem objetivo aparente.",
  "Parece excessivamente sensível aos sons, texturas ou cheiros.",
  "Se separa facilmente (ou frequentemente) dos cuidadores.",
  "Não entende como os acontecimentos se encadeiam entre si (causa e efeito), da mesma maneira que outros da sua idade fazem.",
  "Focaliza (ou dirige) sua atenção para onde os outros estão olhando ou ouvindo.",
  "Tem expressão facial excessivamente séria.",
  "Comporta-se como tola ou ri de forma inadequada.",
  "Tem senso de humor e entende as piadas.",
  "É extremamente hábil em algumas tarefas específicas, mas não consegue fazer tão bem a maioria das outras tarefas.",
  "Tem comportamentos repetitivos, estranhos, tais como agitar as mãos ou balançar o corpo.",
  "Tem dificuldade em responder perguntas diretamente e acaba falando em torno do assunto.",
  "Sabe quando está falando muito alto ou fazendo muito barulho.",
  "Fala com as pessoas com um tom de voz incomum (por exemplo, fala como um robô ou como se estivesse dando uma palestra).",
  "Parece agir com as pessoas como se elas fossem objetos.",
  "Sabe quando está muito próxima ou invadindo o espaço de alguém.",
  "Caminha entre duas pessoas que estão conversando.",
  "Sofre provocações de colegas.",
  "Concentra-se demais em partes das coisas ao invés de ver o todo. Por exemplo, se solicitada para descrever o que aconteceu em uma história, ela pode falar apenas sobre o tipo de roupa que os personagens estavam vestindo.",
  "É excessivamente desconfiada.",
  "É emocionalmente distante, não demonstrando seus sentimentos.",
  "É inflexível e tem dificuldade para mudar de ideia.",
  "Dá explicações incomuns ou ilógicas do porquê de fazer as coisas.",
  "Toca os outros de maneira incomum (por exemplo, pode tocar em alguém apenas para fazer contato e depois ir embora sem dizer nada).",
  "Fica muito agitada em situações sociais.",
  "Fica com olhar perdido ou olha fixamente para o nada."
];
const TOTAL_ITEMS = ITEMS.length; // esperado: 65

/* Opções de resposta de 1 a 4 (SRS-2 padrão) */
const CHOICES = [
  {label:"Não é verdade", value:1},
  {label:"Algumas vezes é verdade", value:2},
  {label:"Muitas vezes é verdade", value:3},
  {label:"Quase sempre é verdade", value:4},
];

/* renderização dinâmica do questionário */
function renderQuestions(){
  const host = $("#qs");
  host.innerHTML = "";

  ITEMS.forEach((text, idx)=>{
    const q = idx+1;
    const qn = String(q).padStart(2,"0");

    const wrap = document.createElement("div");
    wrap.className = "q";
    wrap.setAttribute("data-q", String(q));
    wrap.setAttribute("role","group");
    wrap.setAttribute("aria-labelledby",`lbl${qn}`);

    wrap.innerHTML = `<h3 id="lbl${qn}">${q}. ${text}</h3>`;

    const opts = document.createElement("div");
    opts.className = "opts";

    CHOICES.forEach(c=>{
      const id=`q${qn}_${c.value}`;
      const lab=document.createElement("label");
      lab.className="opt";
      lab.setAttribute("title",`${c.label} (${c.value})`);
      lab.innerHTML = `
        <input type="radio" name="q${qn}" id="${id}" value="${c.value}" required>
        <span>${c.label}</span>`;
      opts.appendChild(lab);
    });

    wrap.appendChild(opts);
    host.appendChild(wrap);
  });

  // atualiza progresso sempre que marcar algo
  const updateProg=()=>{
    const answered = document.querySelectorAll('#qs input[type="radio"]:checked').length;
    $("#progress").textContent = `${answered}/${TOTAL_ITEMS} respondidas`;
  };
  host.addEventListener("change", ()=>{ updateProg(); autosaveAnswers(); });
  updateProg();
}

/* ========== ESTADO GLOBAL / BOOT ========== */
let patient=null, tokenRow=null, CPF="";
let startAt = Date.now();

/* monta cabeçalho com dados da criança */
function renderPatientInfo(){
  const g = $("#pacInfo");
  g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["Nascimento", fmtDateISO(patient.data_nascimento)]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* boot com:
   - valida token
   - busca paciente
   - checa liberação
   - bloqueia duplicidade
   - render UI
*/
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inválido (sem token). Solicite um novo link.","err");
      return;
    }

    // token row
    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];

    const disabled = String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired  = tokenRow.expires_at && (Date.parse(tokenRow.expires_at) < Date.now());
    if(disabled || expired){
      throw new Error("Token desativado/expirado. Peça um novo link.");
    }

    // paciente
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    // liberado?
    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){
      setBox("#alert","Este formulário não está liberado para você.","err");
      return;
    }

    // já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200);
      return;
    }

    // tudo ok -> renderizar UI
    renderPatientInfo();
    renderQuestions();
    restoreAutosave();
    updateProgressAfterRestore();

    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    hideBox("#alert");

    startAt = Date.now();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

/* ========== AUTOSAVE LOCAL ========== */
function autosaveAnswers(){
  const data = {};
  for(let i=1;i<=TOTAL_ITEMS;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{
    localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
  }catch(_){}
}
function restoreAutosave(){
  try{
    const raw = localStorage.getItem(AUTOSAVE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){ el.checked = true; }
    }
  }catch(_){}
}
function clearAutosave(){
  try{ localStorage.removeItem(AUTOSAVE_KEY); }catch(_){}
}
function updateProgressAfterRestore(){
  const answered = document.querySelectorAll('#qs input[type="radio"]:checked').length;
  $("#progress").textContent = `${answered}/${TOTAL_ITEMS} respondidas`;
}

/* ========== SUBESCALAS / ESCORING ========== */
/*
SRS-2: opções cruas vão de 1 a 4.
Itens invertidos (REVERSE_ITEMS) são pontuados como 5 - valor.
Demais itens usam o valor direto.
Depois somamos.
*/

const SUBS = {
  percepcao_social: [2,7,25,32,45,52,54,56],
  cognicao_social: [5,10,15,17,30,40,42,44,48,58,59,62],
  comunicacao_social_subescala: [12,13,16,18,19,21,22,26,33,35,36,37,38,41,46,47,51,53,55,57,60,61],
  motivacao_social: [1,3,6,9,11,23,27,34,43,64,65],
  rrb: [4,8,14,20,24,28,29,31,39,49,50,63] // padrões restritivos e repetitivos
};

/* itens que viram "5 - resposta" */
const REVERSE_ITEMS = new Set([
  3,7,11,12,15,17,21,22,26,32,38,40,43,45,48,52,55
]);

/* devolve resposta já pontuada (1..4, invertendo se necessário) */
function scoredValue(qIndex, rawVal){
  return REVERSE_ITEMS.has(qIndex) ? (5 - rawVal) : rawVal;
}
function sumArray(indices, scored){
  return indices.reduce((s,i)=> s + (scored[i] ?? 0), 0);
}

/* também vamos montar legenda textual pra cada resposta selecionada */
function choiceLabelFor(v){
  const f = CHOICES.find(c=>c.value===v);
  return f ? f.label : String(v);
}

/* ========== SUBMIT ========== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending=true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // 1. coletar respostas (raw e scored)
    const rawAnswers = {};
    const scoredAnswers = {};
    const qaList = [];
    let firstMissing=null;

    for(let i=1;i<=TOTAL_ITEMS;i++){
      const qn = String(i).padStart(2,"0");
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel && firstMissing===null){
        firstMissing=i;
      }
      if(sel){
        const rawVal = Number(sel.value);          // 1..4
        const scrVal = scoredValue(i, rawVal);     // 1..4 (talvez invertido)
        rawAnswers[i] = rawVal;
        scoredAnswers[i] = scrVal;
        qaList.push({
          n:i,
          q:ITEMS[i-1]||"",
          label: choiceLabelFor(rawVal),
          raw: rawVal,
          scored: scrVal
        });
      }
    }

    if(firstMissing){
      setBox("#msg", `Responda o item ${firstMissing}.`, "warn");
      document
        .querySelector(`.q[data-q="${firstMissing}"]`)
        ?.scrollIntoView({behavior:"smooth",block:"center"});
      sending=false;
      btn.disabled=false;
      btn.textContent=originalText;
      return;
    }

    // 2. anti-duplicidade de novo antes de gravar
    const again = await sheetSearch(SHEETS.SCORES, { cpf: onlyDigits(patient.cpf||CPF), code: CODE });
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    // 3. calcula subescalas
    const totalAll = Array.from({length:TOTAL_ITEMS},(_,k)=>k+1)
      .reduce((s,i)=> s + (scoredAnswers[i]||0), 0);

    const rrbScore = sumArray(SUBS.rrb, scoredAnswers);
    const comunicacaoInteracao = totalAll - rrbScore;

    const resultado = {
      percepcao_social: sumArray(SUBS.percepcao_social, scoredAnswers),
      cognicao_social: sumArray(SUBS.cognicao_social, scoredAnswers),
      comunicacao_social: sumArray(SUBS.comunicacao_social_subescala, scoredAnswers),
      motivacao_social: sumArray(SUBS.motivacao_social, scoredAnswers),
      padroes_restritivos_repetitivos: rrbScore,
      comunicacao_interacao: comunicacaoInteracao,
      total: totalAll
    };

    const categoria_csv = [
      `percepcao_social=${resultado.percepcao_social}`,
      `cognicao_social=${resultado.cognicao_social}`,
      `comunicacao_social=${resultado.comunicacao_social}`,
      `motivacao_social=${resultado.motivacao_social}`,
      `padroes_restritivos_repetitivos=${resultado.padroes_restritivos_repetitivos}`,
      `comunicacao_interacao=${resultado.comunicacao_interacao}`,
      `total=${resultado.total}`
    ].join(",");

    const durationSec = Math.round((Date.now()-startAt)/1000);
    const nowISO = new Date().toISOString();
    const resultId = `${patient.cpf || CPF}_${CODE}_${Date.now()}`;

    // 4. envia pra planilha
    const rowScores = {
      result_id: resultId,
      token: TOKEN,
      cpf: patient.cpf || CPF,
      code: CODE,
      source: "professor",
      submitted_at: nowISO,
      total: resultado.total,
      categoria: categoria_csv,
      questions: JSON.stringify(qaList),
      metrics: JSON.stringify({
        answers_raw: rawAnswers,
        answers_scored: scoredAnswers,
        resultado,
        duration_sec: durationSec
      })
    };

    await sheetCreate(SHEETS.SCORES, rowScores);

    // 5. marca como feito no Patients
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    doneUpdates[`${RELEASE_KEYS[0]}_FEITO_AT`] = nowISO;
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf || CPF, doneUpdates);

    // 6. limpa rascunho local e volta pro portal
    clearAutosave();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken,1200);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false;
    btn.disabled=false;
    btn.textContent=originalText;
  }
});
</script>
</body>
</html>
